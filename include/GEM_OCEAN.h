//
//  888    888 8888888 8888888b.  8888888888        d8888  .d8888b.  8888888888 888b     d888
//  888    888   888   888  "Y88b 888              d88888 d88P  Y88b 888        8888b   d8888
//  888    888   888   888    888 888             d88P888 888    888 888        88888b.d88888
//  8888888888   888   888    888 8888888        d88P 888 888        8888888    888Y88888P888
//  888    888   888   888    888 888           d88P  888 888  88888 888        888 Y888P 888
//  888    888   888   888    888 888          d88P   888 888    888 888        888  Y8P  888
//  888    888   888   888  .d88P 888         d8888888888 Y88b  d88P 888        888   "   888
//  888    888 8888888 8888888P"  8888888888 d88P     888  "Y8888P88 8888888888 888       888
// ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
// ▄    ____ ______ ____                                      ▄                              ▄
// █   /    /      \    \   HIDEAGEM STEGANOGRAPHY PLATFORM   █                  .     .     █
// █  /___ /________\ ___\                                    █   .-.   .-.      '.___.'     █
// █  \    \        /    /  ASTRAL SOFTWARE FROM THE FUTURE   █  (_  \ /  _)     .'   `.     █
// █    \   \      /   /                                      █       |         :       :    █
// █      \  \    /  /      COPYRIGHT 2024 WWW.CYBERGEM.NET   █       |         :       :    █
// █        \ \  / /                                          █       |          `.___.'     █
// █           \/           LET'S DO COMPUTER STUFF ALL DAY   █                              █
// █                                                          █                              █
// █ ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ █    ._____.         .--.      █
// █ MMMMMSSSSSSSSSSSSSSSSSSSSSSSSSSddMMMMMSSSSSSMSSSSSSSSSS; █      | |          /   _`.    █
// █ MMMMSSSSSSSSSSSSSSSSSMSSSSS; ;SSdMMMMSSSSSSMMSSSSSSSSSS, █      | |         (_) ( )     █
// █ MMSSSSSSSMSSSSSMSSSSMMMSS."-.-":MMMMMSSSSMMMMSSMSSSMMSS  █     _|_|_       '.    /      █
// █ MSSSSSSSMSSSSMMMSSMMMPTMM;"-/\":MMM^"     MMMSSMMMSSMM   █    '     '        `--'       █
// █ SSSSSSSMMSSMMMMMMMMMP-.MMM :  ;.;P       dMMMMMMMMMP'    █                              █
// █ SSMSSSMMMSMMMMMMMMMP   :M;`:  ;.'+"""t+dMMMMMMMMMMP      █                _             █
// █ MMMSSMMMMMMMMPTMMMM"""":P `.\// '    ""^^MMMMMMMP'       █      .--.     ' `:--.--.     █
// █ MMMMMMPTMMMMP="TMMMsg,      \/   db`c"  dMMMMMP"         █     (    )       |  |  |_    █
// █ MMMMMM  TMMM   d$$$b ^          /T$; ;-/TMMMP'  Let's    █    (_)  /        |  |  | )   █
// █ MMMMM; .^`M; d$P^T$$b          :  $$ ::MMMMP  hide some  █        (_,       |  |  |/    █
// █ MMMMMM   .-+d$$   $$$;         ;. $$ ;;MMMP,    Gems !   █                       (J     █
// █ MMMMMMb   _d$$$   $$$$         :$$$; :MMMMMMp.           █                              █
// █ MMMMMM"  " T$$$._.$$$;          T$P.'MMMSSSSSSb          █                _             █
// █ MMM`TMb   -")T$$$$$$P'       `._ ""  :MMSSSMMP'          █       __      ' `:--.--.     █
// █ MMM / \    '  "T$$P"           /     :MMMMMMP'           █  ___.'  '.___    |  |  |     █
// █ MMSb`. ;                      "      :MMMMMM'            █  ____________    |  |  |     █
// █ MMSSb_lSSSb.             .___.       MMMMMP ,d88b.d88b,  █                  |  |  | .., █
// █ MMMMSSSSSSSSb.                     .MMMMMM. 88888888888  █                        `--': █
// █ MMMMMMMMMMMSSSb                  .dMMMMMMMP `Y8888888Y'  █                              █
// █ MMMMMMMMMMMMMSS;               .dMMMMMMMMMM'  `Y888Y'    █         ...             _    █
// █ MMMMGEMMAMMMMb`;"-.          .dMMMMMMMMMMP'     `Y'      █         .':     \      /_)   █
// █ MMMMMMMMMMMMMMb:   `'--.___.dMMMMMMMMMPP'                █       .'         \    /`.    █
// █ MMMMMMMMMMMMMMMb;           dMMMMMMMMPPR                 █   `..'            \  /   ;   █
// █ ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄ █   .'`.             \/ __.'   █
// █                                                          █                              █
// █          ░░░░░░░░          ▒▒▒▒▒▒▒▒          ░░░░░░░░    █                              █
// █       ▓▓▓░░ ████████    ███▒▒ ▓▓▓▓▓▓▓▓    ▓▓▓░░ ████████ █                 `-.    .-'   █
// █    ▒▒▒▓▓ ░░ ██ ▒▒▒▒▒▒░░░██ ▒▒ ▓▓ ░░░░░░▒▒▒▓▓ ░░ ██+§¥µ██ █ .-"-._.-"-._.-     :  :      █
// █ ███▒▒ ▓▓ ░░░██ ▒▒ ▓▓▓░░ ██ ▒▒▒▓▓ ░░ ███▒▒ ▓▓ ░░░██$@¢¶██ █ .-"-._.-"-._.-   --:--:--    █
// █ ██ ▒▒ ▓▓▓▓▓▓███▒▒ ▓▓ ░░ ██████▓▓▓░░ ██ ▒▒ ▓▓▓▓▓▓████████ █                    :  :      █
// █ ██ ▒▒▒▒▒▒▒▒    ▒▒▒▓▓ ░░░░░░░░    ░░░██ ▒▒▒▒▒▒▒▒          █                 .-'    `-.   █
// █ ████████          ▓▓▓▓▓▓▓▓          ████████    CYBERGEM █                              █
// ▀                                                          ▀                              ▀
// ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀

#pragma /* <3 */ once // upon a time ...

#include <map>
#include <limits>
#include <cstring>

#include "EXCEPTION.h"
#include "TERMINAL_UTILS.h"
#include "OCEAN_BYTE_SET.h"
#include "HIDEAGEM_ENUMS.h"
#include "HIDEAGEM_UTILS.h"

//
//    GEM OCEAN
//

namespace HIDEAGEM_CORE {

class GemOcean
{
public:

    GemOcean(const EGemErrorCode e) : error_code(e) {} // Invalid Gem Ocean

    // Returns OCEAN of size out_ocean_size bytes and out_ocean_type type if successful.
    GemOcean(const void* source_ocean, const uint64_t source_ocean_size);
    
    // Move constructor
    GemOcean(GemOcean&& other) noexcept
    : ocean(other.ocean)
    , _size(other._size)
    , _type(other._type)
    , _width(other._width)
    , _height(other._height)
    , _channels(other._channels)
    , error_code(other.error_code)
    {
        other.ocean = nullptr;
        other.vanish();
    }

    ~GemOcean();

    bool is_valid() const;

	// Returns a pointer to the ocean data and sets internal ocean data pointer to nullptr.
	// Does not erase any internal data such as size or type etc.
    // IMPORTANT NOTE: Caller becomes responsible for freeing the returned ocean data memory!
    uint8_t* take();

    uint64_t size() const;

    uint64_t num_bytes_remaining() const
    {
        return byte_set->remaining();
    }

    uint64_t num_bytes_reserved() const
    {
        return byte_set->num_set();
    }

    uint64_t remaining_byte_capacity(const EBitMode bit_mode) const
    {
        return ( bit_mode * ( num_bytes_remaining() ) ) / 8;
    }

    bool is_reserved( size_t idx ) const
    {
        return byte_set->is_set(idx);
    }

    void reserve( size_t idx )
    {
        byte_set->set( idx );
    }

    // Switches to byte set with set_key, creating it if it does not exist.
    void switch_byte_set(const char* set_key);

	// Deletes byte set with key delete_key, if it exists.
    void delete_byte_set(const char* delete_key);

    EOceanType type() const { return _type; }
    
    int width() const { return _width; }
    int height() const { return _height; }
    int channels() const { return _channels; }

    EGemErrorCode get_error() const { return error_code; }

    void finalize();

    void vanish();


    uint8_t& operator[](size_t idx) 
    {
        switch ( _type )
        {
            case EOceanType::IMAGE_RGBA :

                return ocean[ RGB_to_RGBA_index( idx ) ];

            default :

                return ocean[ idx ];
        }
    }

    const uint8_t& operator[](size_t idx) const 
    {
        switch ( _type )
        {
            case EOceanType::IMAGE_RGBA :

                return ocean[ RGB_to_RGBA_index( idx ) ];

            default :

                return ocean[ idx ];
        }
    }

protected:

    static constexpr const char* DEFAULT_BYTE_SET_KEY = "___BYTE_SET_KEY_ZERO___";

    // DELETE COPY CONSTRUCTOR
    GemOcean(const GemOcean& other) = delete;

    bool b_finalized = false;

    uint8_t* ocean = nullptr;

    // Reserved OCEAN bytes sets
    const char* byte_set_key = DEFAULT_BYTE_SET_KEY;
    OceanByteSet* byte_set = nullptr;

    std::map<const char*, OceanByteSet> byte_set_map;

    uint64_t _size = 0;
    EOceanType _type = EOceanType::BYTES;

    int _width = 0;
    int _height = 0;
    int _channels = 0;

    EGemErrorCode error_code = EGemErrorCode::NONE;

    size_t RGB_to_RGBA_index(size_t idx) const
    {
        return (idx / 3) * 4 + (idx % 3);
    }
};

}; // namespace HIDEAGEM_CORE

