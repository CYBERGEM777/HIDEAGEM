//
//  888    888 8888888 8888888b.  8888888888        d8888  .d8888b.  8888888888 888b     d888
//  888    888   888   888  "Y88b 888              d88888 d88P  Y88b 888        8888b   d8888
//  888    888   888   888    888 888             d88P888 888    888 888        88888b.d88888
//  8888888888   888   888    888 8888888        d88P 888 888        8888888    888Y88888P888
//  888    888   888   888    888 888           d88P  888 888  88888 888        888 Y888P 888
//  888    888   888   888    888 888          d88P   888 888    888 888        888  Y8P  888
//  888    888   888   888  .d88P 888         d8888888888 Y88b  d88P 888        888   "   888
//  888    888 8888888 8888888P"  8888888888 d88P     888  "Y8888P88 8888888888 888       888
// ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
// ▄    ____ ______ ____                                      ▄                              ▄
// █   /    /      \    \   HIDEAGEM STEGANOGRAPHY PLATFORM   █                  .     .     █
// █  /___ /________\ ___\                                    █   .-.   .-.      '.___.'     █
// █  \    \        /    /  ASTRAL SOFTWARE FROM THE FUTURE   █  (_  \ /  _)     .'   `.     █
// █    \   \      /   /                                      █       |         :       :    █
// █      \  \    /  /      COPYRIGHT 2024 WWW.CYBERGEM.NET   █       |         :       :    █
// █        \ \  / /                                          █       |          `.___.'     █
// █           \/           LET'S DO COMPUTER STUFF ALL DAY   █                              █
// █                                                          █                              █
// █ ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ █    ._____.         .--.      █
// █ MMMMMSSSSSSSSSSSSSSSSSSSSSSSSSSddMMMMMSSSSSSMSSSSSSSSSS; █      | |          /   _`.    █
// █ MMMMSSSSSSSSSSSSSSSSSMSSSSS; ;SSdMMMMSSSSSSMMSSSSSSSSSS, █      | |         (_) ( )     █
// █ MMSSSSSSSMSSSSSMSSSSMMMSS."-.-":MMMMMSSSSMMMMSSMSSSMMSS  █     _|_|_       '.    /      █
// █ MSSSSSSSMSSSSMMMSSMMMPTMM;"-/\":MMM^"     MMMSSMMMSSMM   █    '     '        `--'       █
// █ SSSSSSSMMSSMMMMMMMMMP-.MMM :  ;.;P       dMMMMMMMMMP'    █                              █
// █ SSMSSSMMMSMMMMMMMMMP   :M;`:  ;.'+"""t+dMMMMMMMMMMP      █                _             █
// █ MMMSSMMMMMMMMPTMMMM"""":P `.\// '    ""^^MMMMMMMP'       █      .--.     ' `:--.--.     █
// █ MMMMMMPTMMMMP="TMMMsg,      \/   db`c"  dMMMMMP"         █     (    )       |  |  |_    █
// █ MMMMMM  TMMM   d$$$b ^          /T$; ;-/TMMMP'  Let's    █    (_)  /        |  |  | )   █
// █ MMMMM; .^`M; d$P^T$$b          :  $$ ::MMMMP  hide some  █        (_,       |  |  |/    █
// █ MMMMMM   .-+d$$   $$$;         ;. $$ ;;MMMP,    Gems !   █                       (J     █
// █ MMMMMMb   _d$$$   $$$$         :$$$; :MMMMMMp.           █                              █
// █ MMMMMM"  " T$$$._.$$$;          T$P.'MMMSSSSSSb          █                _             █
// █ MMM`TMb   -")T$$$$$$P'       `._ ""  :MMSSSMMP'          █       __      ' `:--.--.     █
// █ MMM / \    '  "T$$P"           /     :MMMMMMP'           █  ___.'  '.___    |  |  |     █
// █ MMSb`. ;                      "      :MMMMMM'            █  ____________    |  |  |     █
// █ MMSSb_lSSSb.             .___.       MMMMMP ,d88b.d88b,  █                  |  |  | .., █
// █ MMMMSSSSSSSSb.                     .MMMMMM. 88888888888  █                        `--': █
// █ MMMMMMMMMMMSSSb                  .dMMMMMMMP `Y8888888Y'  █                              █
// █ MMMMMMMMMMMMMSS;               .dMMMMMMMMMM'  `Y888Y'    █         ...             _    █
// █ MMMMGEMMAMMMMb`;"-.          .dMMMMMMMMMMP'     `Y'      █         .':     \      /_)   █
// █ MMMMMMMMMMMMMMb:   `'--.___.dMMMMMMMMMPP'                █       .'         \    /`.    █
// █ MMMMMMMMMMMMMMMb;           dMMMMMMMMPPR                 █   `..'            \  /   ;   █
// █ ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄ █   .'`.             \/ __.'   █
// █                                                          █                              █
// █          ░░░░░░░░          ▒▒▒▒▒▒▒▒          ░░░░░░░░    █                              █
// █       ▓▓▓░░ ████████    ███▒▒ ▓▓▓▓▓▓▓▓    ▓▓▓░░ ████████ █                 `-.    .-'   █
// █    ▒▒▒▓▓ ░░ ██ ▒▒▒▒▒▒░░░██ ▒▒ ▓▓ ░░░░░░▒▒▒▓▓ ░░ ██+§¥µ██ █ .-"-._.-"-._.-     :  :      █
// █ ███▒▒ ▓▓ ░░░██ ▒▒ ▓▓▓░░ ██ ▒▒▒▓▓ ░░ ███▒▒ ▓▓ ░░░██$@¢¶██ █ .-"-._.-"-._.-   --:--:--    █
// █ ██ ▒▒ ▓▓▓▓▓▓███▒▒ ▓▓ ░░ ██████▓▓▓░░ ██ ▒▒ ▓▓▓▓▓▓████████ █                    :  :      █
// █ ██ ▒▒▒▒▒▒▒▒    ▒▒▒▓▓ ░░░░░░░░    ░░░██ ▒▒▒▒▒▒▒▒          █                 .-'    `-.   █
// █ ████████          ▓▓▓▓▓▓▓▓          ████████    CYBERGEM █                              █
// ▀                                                          ▀                              ▀
// ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀

#include "HIDEAGEM_C_WRAPPER.h"
#include "HIDEAGEM_CORE.h"
#include "GEM_OCEAN.h"
#include "GEM_FILE.h"

#include <limits>
#include <iostream>

//
//    HIDEAGEM C WRAPPER
//

// Returns a pointer to Gem Ocean data.
// WARNING !!! Caller is responsible for freeing Gem Ocean memory !
uint8_t* HIDEAGEM_HIDE_GEMS_C(
    int gem_protocol,
    void* ocean,
    uint64_t ocean_size,
    const char** file_paths,
    int file_paths_length,
    const char* password,
    int time_trap,
    uint64_t* out_ocean_size,
    bool b_validate
)
{
    if ( ocean == nullptr )
    {
        std::cerr << "Ocean is nullptr.\n\n";

        return nullptr;
    }
    else if ( out_ocean_size == nullptr )
    {
        std::cerr << "Out Ocean size is nullptr.\n\n";

        return nullptr;
    }
    else if ( file_paths == nullptr )
    {
        std::cerr << "Gem File paths are nullptr.\n\n";

        return nullptr;
    }
    else if ( out_ocean_size == nullptr )
    {
        std::cerr << "Out Ocean size is nullptr.\n\n";

        return nullptr;
    }

    std::vector<std::string> file_paths_vec;

    for (int i = 0; i < file_paths_length; ++i)
    {
        file_paths_vec.push_back(std::string(file_paths[i]));
    }

    std::string password_str(password);
    HIDEAGEM_CORE::EGemErrorCode error_code;

    HIDEAGEM_CORE::GemOcean out_ocean = HIDEAGEM_CORE::hide_gems(
        gem_protocol,
        ocean,
        ocean_size,
        { file_paths_vec },
        { password_str },
        { time_trap },
        b_validate
    );

    // TODO return error_code

    if ( ! out_ocean.is_valid() )
    {
        *out_ocean_size = 0;

        return nullptr;
    }

    // Finalize Gem Ocean data (e.g. write pixel data to PNG image file)
    out_ocean.finalize();
    *out_ocean_size = out_ocean.size(); // Must call after finalize()

    // WARNING !!! Caller is now responsible for freeing Ocean memory !
    return out_ocean.take();
}


// Returns a pointer to Gem Ocean data.
// WARNING !!! Caller is responsible for freeing Gem Ocean memory !
uint8_t* HIDEAGEM_HIDE_GEMS_32_BIT_C(
    int gem_protocol,
    void* ocean,
    uint32_t ocean_size,
    const char** file_paths,
    int file_paths_length,
    const char* password,
    int time_trap,
    uint32_t* out_ocean_size,
    bool b_validate
)
{
    uint64_t _out_ocean_size = 0;

    uint8_t* out_ocean = HIDEAGEM_HIDE_GEMS_C(
        gem_protocol,
        ocean,
        ocean_size,
        file_paths,
        file_paths_length,
        password,
        time_trap,
        &_out_ocean_size,
        b_validate
    );

    *out_ocean_size = _out_ocean_size;

    return out_ocean;
}


// Returns a pointer to Gem Ocean data.
// WARNING !!! Caller is responsible for freeing Gem Ocean memory !
uint8_t* HIDEAGEM_HIDE_GEM_FILES_C(
    int gem_protocol,
    void* ocean,
    uint64_t ocean_size,
    const uint8_t** gem_files,
    const uint64_t* gem_file_sizes,
    const char** gem_file_names,
    const uint64_t num_gem_files,
    const char* password,
    int time_trap,
    uint64_t* out_ocean_size,
    bool b_validate
)
{
    if ( ocean == nullptr )
    {
        std::cerr << "Ocean is nullptr.\n\n";

        return nullptr;
    }
    else if ( out_ocean_size == nullptr )
    {
        std::cerr << "Out Ocean size is nullptr.\n\n";

        return nullptr;
    }
    else if ( gem_files == nullptr )
    {
        std::cerr << "Gem Files are nullptr.\n\n";

        return nullptr;
    }
    else if ( gem_file_sizes == nullptr )
    {
        std::cerr << "Gem File sizes are nullptr.\n\n";

        return nullptr;
    }
    else if ( out_ocean_size == nullptr )
    {
        std::cerr << "Out Ocean size is nullptr.\n\n";

        return nullptr;
    }

    std::string password_str(password);
    HIDEAGEM_CORE::EGemErrorCode error_code;

    std::vector<HIDEAGEM_CORE::GemFile> _gem_files;

    for (int i = 0; i < num_gem_files; ++i)
    {
        _gem_files.push_back(
            HIDEAGEM_CORE::GemFile( gem_files[i], gem_file_sizes[i], gem_file_names[i], false /* b_pack */ )
        );
    }

    HIDEAGEM_CORE::GemOcean out_ocean = HIDEAGEM_CORE::hide_gems(
        gem_protocol,
        ocean,
        ocean_size,
        _gem_files,
        password_str,
        time_trap,
        b_validate
    );

    // TODO return error_code

    if ( ! out_ocean.is_valid() )
    {
        *out_ocean_size = 0;

        return nullptr;
    }

    // Finalize Gem Ocean data (e.g. write pixel data to PNG image file)
    out_ocean.finalize();
    *out_ocean_size = out_ocean.size(); // Must call after finalize()

    // WARNING !!! Caller is now responsible for freeing Ocean memory !
    return out_ocean.take();
}


// Returns a pointer to Gem Ocean data.
// WARNING !!! Caller is responsible for freeing Gem Ocean memory !
uint8_t* HIDEAGEM_HIDE_GEM_FILES_32_BIT_C(
    int gem_protocol,
    void* ocean,
    uint32_t ocean_size,
    const uint8_t** gem_files,
    const uint32_t* gem_file_sizes,
    const char** gem_file_names,
    const uint32_t num_gem_files,
    const char* password,
    int time_trap,
    uint32_t* out_ocean_size,
    bool b_validate
)
{
    uint64_t _out_ocean_size = 0;

    std::vector<uint64_t> sizes_64;
    for (int i = 0; i < num_gem_files; ++i)
    {
        sizes_64.push_back( static_cast<uint64_t>( gem_file_sizes[i] ) );
    }

    uint8_t* out_ocean = HIDEAGEM_HIDE_GEM_FILES_C(
        gem_protocol,
        ocean,
        ocean_size,
        gem_files,
        sizes_64.data(),
        gem_file_names,
        num_gem_files,
        password,
        time_trap,
        &_out_ocean_size,
        b_validate
    );

    *out_ocean_size = _out_ocean_size;

    return out_ocean;
}


void HIDEAGEM_FIND_GEMS_C(
    void* ocean,
    uint64_t ocean_size,
    const char* password,
    const char* output_dir,
    bool b_time_trap
)
{
    std::string password_str(password);

    std::string output_dir_str;
    std::string* optional_output_dir = nullptr;

    if ( output_dir != nullptr )
    {
        output_dir_str = std::string( output_dir );
        optional_output_dir = &output_dir_str;
    }

    FOUND_GEM_FILES_C =
        HIDEAGEM_CORE::find_gems(
            ocean,
            ocean_size,
            { password_str },
            optional_output_dir,
            { b_time_trap }
        );
}


void HIDEAGEM_FIND_GEMS_32_BIT_C(
    void* ocean,
    uint32_t ocean_size,
    const char* password,
    const char* output_dir,
    bool b_time_trap
)
{
    HIDEAGEM_FIND_GEMS_C(
        ocean,
        ocean_size,
        password,
        output_dir,
        b_time_trap
    );
}


void HIDEAGEM_ACTIVATE_DEMO_MODE_C()
{
    HIDEAGEM_CORE::RUN_UNIT_TESTS(true, true);
}


bool HIDEAGEM_RUN_UNIT_TESTS_C(
    bool b_loop,
    bool b_demo_mode
)
{
    return HIDEAGEM_CORE::RUN_UNIT_TESTS(
        b_loop,
        b_demo_mode
    );
}


HIDEAGEM_DLL_EXPORT void HIDEAGEM_FREE_OCEAN_C(void* ocean)
{
    if ( ocean != nullptr )
    {
        free( ocean );
    }
}

